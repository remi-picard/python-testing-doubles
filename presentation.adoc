= Python - Tester avec les Doubles
R√©mi PICARD <picard.remi@gmail.com>
:website: https://remi-picard.github.io/cv/
:lang: fr
:source-highlighter: highlightjs
:highlightjs-theme: reveal.js/lib/css/zenburn.css
:revealjs_history: true
:revealjs_theme: white
:revealjs_slideNumber: true
:revealjs_mouseWheel: true
:customcss: assets/presentation.css

////
:doctype: book
:reproducible:
:source-highlighter: coderay
:listing-caption: Listing
:pdf-page-size: Letter
////

== Pourquoi tester ?

- D√©tecter automatiquement les r√©gressions
- V√©rifier que le code est modulaire / facilement r√©utilisable
- Permet de documenter


== Structure d'un test

- **A**rrange / Given => Pr√©paration des donn√©es d'entr√©e
- **A**ct     / When  => Appel de la m√©thode √† tester
- **A**ssert  / Then  => V√©rifications (retour, changement d'√©tat)

== Structure d'un test

[source,python]
----
def test_simple():
    # ARRANGE
    a = 1
    b = 2

    # ACT
    got = a + b

    # ASSERT
    assert got == 3

def test_very_simple():
    assert 1 + 2 == 3
----

== Fonctions pures

- Des entr√©es
- Une sortie
- On ne modifie pas les entr√©es
- Pas d'effet de bord
- Tr√®s simple √† tester

== Framework de tests

- pytest
- unittest

üèÜ pytest : L√©ger, compatible, markers/fixtures/param√©trisation


Mais aussi doctest, hypothesis ...


== Dans la vraie vie ...

=== Effets de bord

- Commande syst√®me
- File System
- Connexion √† une base de donn√©es

=== D√©pendances

image::assets/dependencies.png[]

=== Entr√©es complexes

- Retour d'une API (DataScience, Base de donn√©es...)
- Pas de constructeur

=== Structure d'un test avec Double

- Arrange / Given => Pr√©paration des donn√©es d'entr√©e et des doubles
- Act     / When  => Appel de la m√©thode √† tester
- Assert  / Then  => V√©rifications (**appels de m√©thode**)

== Les Doubles ü¶Ñü¶Ñ

=== Dummies ~ Nulles

Valeurs non utilis√©es par le code. Elles permettent de remplir les param√®tres des m√©thodes √† tester.

[source,python]
----
# Source
def do_some_stuff(param1, param2):
    if param1 == 42:
        return False
    # ...
    if param2 % param1 == 5:
        return True
    return None

# Test
def test_dummies():
    dummy = None
    assert not do_some_stuff(42, dummy)
----

=== Stubs ~ Bout, moignon

Objet qui produit les r√©ponses dont on a besoin pour faire passer le test.

[source,python]
----
# Source
import math
def get_cosinus(x):
    return math.cos(x)

# Test
def test_stubs_math_cos(monkeypatch):
    def stub_cos(*args, **kwargs):
        return args[0]
    monkeypatch.setattr(math, 'cos', stub_cos)
    assert get_cosinus(5) == 5
----

=== Mocks ~ ü§° / Spies ~ Espions

Objet type proxy qui enregistre s'il a √©t√© appel√© et avec quels param√®tres.

Un **Mock** est une coquille vide qui ne retourne rien.

Un **Spy** appelle le code de l'objet qu'il remplace. On ne surcharge que certaines m√©thodes.

üßô‚Äç‚ôÇÔ∏è D√©mo

=== Fake objects ~ Faux, truqu√©s

Objet rempla√ßant la d√©pendance avec une impl√©mentation fonctionnelle mais qui ne sera pas utilis√©e en production.

Exemple : Base de donn√©es en m√©moire

=== Framework de Doubles

- mock ~ unittest.mock (dispo pour python >= 3.3)
- monkeypatch

=== R√©cap

|=======
|Replacement des d√©pendances |V√©rification des interactions
|Dummies                     |Spy
|Stubs                       |Mock
|Fakes                       |
|=======


=== Complexit√©

image::assets/test-doubles-complexity.svg[]

=== Limites

- On ne teste pas l'int√©gration des composants
- Compliqu√© √† √©crire si de nombreuses d√©pendances
- Maintenance tr√®s co√ªteuse (tous les mocks √† r√©√©crire si l'API change)
- Certains cas ne se produiront pas en production


== R√©f√©rences

https://martinfowler.com/bliki/TestDouble.html[Martin Fowler - TestDouble]

https://app.pluralsight.com/library/courses/using-unit-testing-python/table-of-contents[Emily Bache - Unit Testing with Python]

http://xunitpatterns.com/Test%20Double%20Patterns.html[xUnit Patterns]

https://ervin.ipsquad.net/slides/talks/ak2015-test-doubles/#/[Franck Arrecot & Kevin Ottens - Test Doubles]

https://piraveenaparalogarajah.medium.com/what-is-mocking-in-testing-d4b0f2dbe20a[What is Mocking in Testing?]

== Des questions ?

Merci pour votre attention.